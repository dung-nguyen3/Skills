<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Respiratory Physiology — L37–L40 Quiz (Mobile Safe)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#8b5cf6; --good:#22c55e; --bad:#ef4444; --chip:#1f2937; --border:#1f2937;
    --hdrH:64px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(135deg,#0f172a,#0b1220);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.45;
    padding-top:var(--hdrH); /* prevent header from covering content */
  }
  /* Fixed, not sticky; content gets padded down */
  header{
    height:var(--hdrH); position:fixed; inset:0 0 auto 0; z-index:10;
    padding:10px 16px; border-bottom:1px solid var(--border);
    background:#0b1220e6; backdrop-filter:blur(6px);
    display:flex; flex-direction:column; justify-content:center;
  }
  h1{font-size:16px;margin:0 0 4px} .sub{color:var(--muted);font-size:12px}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  .controls{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;margin-bottom:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  select,button,input[type="checkbox"],textarea{
    background:#0b1220;color:var(--ink);border:1px solid #263143;border-radius:10px;padding:10px;font-size:14px
  }
  button{cursor:pointer;transition:.2s;background:var(--accent);color:#fff;border:0}
  button.ghost{background:#1f2937}
  button:hover{filter:brightness(1.07)}
  .chip{background:var(--chip);border:1px solid #293041;color:var(--ink);padding:4px 10px;border-radius:999px;font-size:12px}
  .progress{height:10px;background:#1f2937;border-radius:20px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#8b5cf6,#34d399)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:10px}
  .qtext{font-size:16px}
  .opt{border:1px solid #243044;border-radius:12px;padding:10px;margin:.5rem 0;display:flex;gap:10px;align-items:flex-start;cursor:pointer;background:#0b1220}
  .opt input{margin-top:4px}
  .opt.correct{border-color:rgba(34,197,94,.65);background:rgba(34,197,94,.08)}
  .opt.incorrect{border-color:rgba(239,68,68,.6);background:rgba(239,68,68,.06)}
  .explain{font-size:14px;color:#cbd5e1;border-left:3px solid #334155;padding-left:10px;margin-top:8px}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2b3447;background:#0b1220}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
  .btnRow{display:flex;gap:8px;flex-wrap:wrap}
  details{border:1px dashed #334155;border-radius:12px;padding:10px}
  textarea{width:100%;min-height:140px}
  /* Mobile tweaks */
  @media (max-width:640px){
    #chapterFilter{width:100%; min-width:0}
    .qtext{font-size:15px}
    .opt{padding:12px}
  }
</style>
</head>
<body>
<header>
  <h1>Respiratory Physiology — L37–L40 High-Yield Quiz (40 Qs)</h1>
  <div class="sub">2nd-order • No calculations • Filter by chapter or mix</div>
</header>

<div class="wrap">
  <div class="controls card">
    <div class="row" style="align-items:flex-start">
      <label style="min-width:220px;flex:1">Chapters (pick one or more; blank = mix):
        <!-- smaller list on mobile to avoid huge control pushing content off-screen -->
        <select id="chapterFilter" multiple size="4" title="Choose chapters"></select>
      </label>
      <div class="row" style="align-items:center">
        <label><input type="checkbox" id="shuffle" checked> Shuffle</label>
        <label><input type="checkbox" id="explainAll" checked> Auto-show explanations</label>
        <button id="start">Start / Reset</button>
      </div>
    </div>
    <div class="progress" aria-label="progress"><div class="bar" id="bar"></div></div>
    <div class="row">
      <span class="chip" id="countChip">0/40</span>
      <span class="chip" id="scoreChip">Score: 0</span>
    </div>
  </div>

  <div id="quiz" aria-live="polite"></div>

  <div class="card">
    <details>
      <summary><strong>Add / Import Questions</strong> (paste JSON array to append)</summary>
      <p style="margin-top:8px">Format:
        <code>{ id, chapter, stem, choices:[{text,correct,why}], tags }</code>
      </p>
      <textarea id="json-input" placeholder='[ { "id":"L37-11", "chapter":"37 Gas Transport", "stem":"...", "choices":[{"text":"A","correct":true,"why":"..."},{"text":"B","correct":false,"why":"..."}] } ]'></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btn-import" class="ghost">Import & Append</button>
        <button id="btn-export" class="ghost">Export Current Questions</button>
      </div>
    </details>
  </div>
</div>

<script>
/* ===== Questions (same as previous L37–L40, 10 each) ===== */
const QUESTIONS = [
  /* L37 Gas Transport (10) */ 
  { id:"L37-01", chapter:"37 Gas Transport", stem:"An anemic patient has normal PaO₂ and SaO₂ on ABG/pulse-ox but presents with exertional fatigue. Which single statement best explains tissue hypoxia?", choices:[{text:"O₂ content is reduced because hemoglobin concentration is low despite normal saturation", correct:true, why:"CaO₂ depends heavily on [Hb]. With normal PaO₂/SaO₂, low Hb → low content → low delivery (DO₂)."}, {text:"Dissolved O₂ rises to fully compensate for hemoglobin loss", correct:false, why:"Dissolved O₂ is tiny at physiologic PaO₂; it cannot compensate."}, {text:"PaO₂ directly equals O₂ content", correct:false, why:"Partial pressure ≠ content; content primarily reflects Hb-bound O₂."}, {text:"A–a gradient widens due to anemia", correct:false, why:"Anemia does not widen A–a; it lowers content."}]},
  { id:"L37-02", chapter:"37 Gas Transport", stem:"A febrile, acidotic, hypercapnic limb shows high O₂ extraction during sepsis. What change in the O₂–Hb curve occurs locally and why is it adaptive?", choices:[{text:"Right shift (↑P50) improves unloading to meet metabolic demand", correct:true, why:"Bohr effect (↑CO₂/↓pH) + heat → right shift → easier O₂ release."}, {text:"Left shift (↓P50) improves unloading", correct:false, why:"Left shift impairs unloading at a given PO₂."}, {text:"No shift; only flow changes affect unloading", correct:false, why:"Affinity shifts significantly affect unloading."}, {text:"Right shift reduces tissue O₂ delivery", correct:false, why:"It enhances delivery at tissues."}]},
  { id:"L37-03", chapter:"37 Gas Transport", stem:"A patient with CO poisoning has headache and nausea. Which pair best describes arterial values?", choices:[{text:"Normal PaO₂ with low SaO₂ and reduced O₂ content", correct:true, why:"PaO₂ reflects dissolved O₂ (normal); CO occupies Hb sites → low SaO₂ and content; remaining sites are left-shifted (poor unloading)."}, {text:"Low PaO₂ with normal SaO₂", correct:false, why:"Opposite pattern."}, {text:"Normal PaO₂ and normal SaO₂", correct:false, why:"SaO₂ is reduced by COHb; pulse-ox may misread but co-oximetry reveals it."}, {text:"High PaO₂ with high SaO₂", correct:false, why:"Neither is typically high in CO poisoning."}]},
  { id:"L37-04", chapter:"37 Gas Transport", stem:"Why does methemoglobinemia impair O₂ delivery despite normal PaO₂?", choices:[{text:"Fe³⁺ heme cannot bind O₂ and remaining Fe²⁺ sites hold O₂ more tightly (left shift)", correct:true, why:"Capacity falls and unloading worsens → tissue hypoxia with normal PaO₂."}, {text:"Fe³⁺ increases DLCO", correct:false, why:"Unrelated; DLCO often decreases."}, {text:"Fe³⁺ increases dissolved plasma O₂", correct:false, why:"Dissolved O₂ minimal."}, {text:"Fe³⁺ raises Hb concentration", correct:false, why:"No—functional capacity falls."}]},
  { id:"L37-05", chapter:"37 Gas Transport", stem:"Which statement about the Haldane effect is correct at the lungs?", choices:[{text:"Oxygenation of Hb promotes CO₂ release (↓carbamino and H⁺ buffering)", correct:true, why:"O₂ loading reduces Hb's ability to carry CO₂/H⁺ → CO₂ off-loading in lungs (Haldane)."}, {text:"Deoxygenation promotes CO₂ release", correct:false, why:"DeoxyHb actually carries more CO₂/H⁺ in tissues."}, {text:"It describes O₂’s effect on DLCO", correct:false, why:"It’s about CO₂ carriage versus Hb oxygenation."}, {text:"It is the same as the Bohr effect", correct:false, why:"Bohr: CO₂/H⁺ effect on O₂ affinity; Haldane: O₂ effect on CO₂ carriage."}]},
  { id:"L37-06", chapter:"37 Gas Transport", stem:"Which change most increases mixed venous O₂ saturation (SvO₂) if VO₂ is constant?", choices:[{text:"Increased cardiac output", correct:true, why:"Higher flow → less extraction per unit blood → higher SvO₂."}, {text:"Right shift of O₂–Hb curve", correct:false, why:"Right shift increases unloading → lowers SvO₂ at constant VO₂."}, {text:"Anemia", correct:false, why:"Lower content → more extraction fractionally → SvO₂ falls."}, {text:"Cyanide toxicity reversal", correct:false, why:"Cyanide itself raises SvO₂ (extraction failure); reversal would lower it back toward normal."}]},
  { id:"L37-07", chapter:"37 Gas Transport", stem:"Why doesn’t dissolved O₂ meet metabolic demand at normal PaO₂?", choices:[{text:"Solubility is too low; Hb binding massively amplifies O₂ carriage", correct:true, why:"At PaO₂ ~100, dissolved O₂ ≈ 0.3 mL/dL — far below needs."}, {text:"Dissolved O₂ cannot diffuse across capillary wall", correct:false, why:"It diffuses; quantity is the issue."}, {text:"Capillary recruitment requires Hb to open vessels", correct:false, why:"Recruitment is hemodynamic, not Hb-dependent."}, {text:"Alveolar PO₂ cannot exceed 60 mmHg", correct:false, why:"Normal PAO₂ ~100 mmHg at sea level."}]},
  { id:"L37-08", chapter:"37 Gas Transport", stem:"At the tissue capillary, which intracellular reaction predominates for CO₂ handling?", choices:[{text:"CO₂ → H₂CO₃ → H⁺ + HCO₃⁻ via carbonic anhydrase in RBCs", correct:true, why:"Generates bicarbonate; H⁺ buffered by deoxyHb; HCO₃⁻ exits via Cl⁻ shift."}, {text:"CO₂ binds albumin in plasma (>80%)", correct:false, why:"Minor pathway; bicarbonate is major."}, {text:"CO₂ is stored in myocytes until exhaled", correct:false, why:"Transported in blood to lungs."}, {text:"Conversion to CO via heme oxygenase", correct:false, why:"Not physiologic."}]},
  { id:"L37-09", chapter:"37 Gas Transport", stem:"A rightward shift of the O₂–Hb curve (↑P50) causes which change at a fixed PO₂?", choices:[{text:"Lower Hb saturation, facilitating unloading", correct:true, why:"At the same PO₂, right shift yields lower SaO₂ → better tissue delivery."}, {text:"Higher Hb saturation, impairing unloading", correct:false, why:"That’s left shift."}, {text:"No change in saturation", correct:false, why:"Affinity changes alter saturation."}, {text:"Increased A–a gradient", correct:false, why:"Curve shift doesn’t alter A–a."}]},
  { id:"L37-10", chapter:"37 Gas Transport", stem:"Why does cyanide poisoning present with normal PaO₂/SaO₂ but lactic acidosis?", choices:[{text:"Cells cannot use O₂ (histotoxic hypoxia), so extraction falls and venous O₂ rises", correct:true, why:"Mitochondrial blockade → high SvO₂, low utilization → lactate."}, {text:"Anatomic shunt bypasses the lungs", correct:false, why:"Shunt lowers PaO₂."}, {text:"COHb formation blocks O₂ binding", correct:false, why:"Different toxin (CO)."}, {text:"Extreme anemia", correct:false, why:"Anemia lowers CaO₂ but PaO₂ is normal; venous O₂ typically falls with increased extraction."}]},

  /* L38 Pulmonary Blood Flow/VQ (10) */
  { id:"L38-01", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"A mucus plug blocks airflow to a segment. Which local vascular response is most adaptive?", choices:[{text:"Hypoxic pulmonary vasoconstriction diverts blood away from poorly ventilated units", correct:true, why:"Low PAO₂ triggers vasoconstriction → better V/Q matching."}, {text:"Vasodilation to wash out CO₂", correct:false, why:"Pulmonary vessels constrict in hypoxia."}, {text:"Systemic-style autoregulation to fixed flow", correct:false, why:"Pulmonary bed behaves differently."}, {text:"Recruitment of zone 1 vessels at the apex", correct:false, why:"Zone 1 is limited; not the mechanism."}]},
  { id:"L38-02", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"In an upright lung at rest, why is V/Q highest at the apex?", choices:[{text:"Perfusion falls more steeply than ventilation toward the apex", correct:true, why:"Both drop upward; perfusion drops faster → high V/Q."}, {text:"Ventilation is uniform while perfusion falls", correct:false, why:"Ventilation also falls upward."}, {text:"Apex always has zone 1 with no flow in health", correct:false, why:"May occur, but not universal."}, {text:"Base alveoli are on a flatter compliance curve", correct:false, why:"Base is on steeper portion → more ventilation there."}]},
  { id:"L38-03", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Pulmonary embolism abruptly lowers end-tidal CO₂ during anesthesia. Why?", choices:[{text:"Increased dead space from loss of perfusion reduces exhaled CO₂", correct:true, why:"Less CO₂ reaches alveoli → ETCO₂ falls."}, {text:"Large shunt increases exhaled CO₂", correct:false, why:"Shunt lowers oxygenation; doesn’t raise ETCO₂."}, {text:"CO₂ production stops immediately", correct:false, why:"Metabolism continues."}, {text:"Ventilation ceases", correct:false, why:"Ventilation persists; perfusion is lost."}]},
  { id:"L38-04", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Which statement about shunt physiology explains poor response to supplemental O₂?", choices:[{text:"Shunted blood never contacts alveolar gas; raising PAO₂ only helps ventilated units", correct:true, why:"Unventilated units remain uncorrected; PaO₂ rises minimally."}, {text:"Shunt creates infinite V/Q", correct:false, why:"Shunt is V/Q→0; dead space is V/Q→∞."}, {text:"O₂ worsens HPV and increases shunt", correct:false, why:"O₂ relieves HPV."}, {text:"Diffusion limitation is the primary cause", correct:false, why:"Shunt is ventilation absence."}]},
  { id:"L38-05", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"During exercise, pulmonary vascular resistance falls even as flow rises. Why?", choices:[{text:"Capillary recruitment and distension open more channels", correct:true, why:"Parallel pathways lower total resistance with higher pressures/flows."}, {text:"Arteriolar vasoconstriction to protect capillaries", correct:false, why:"Opposite occurs."}, {text:"Increased blood viscosity at speed", correct:false, why:"Viscosity doesn’t fall; recruitment explains PVR drop."}, {text:"Conversion to zone 1 at the base", correct:false, why:"Base remains well perfused (zone 3)."}]},
  { id:"L38-06", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Which regional pattern best characterizes physiologic dead space?", choices:[{text:"Ventilated but under-perfused units (V/Q→∞)", correct:true, why:"Examples: apex regions, PE-affected areas."}, {text:"Perfused but unventilated units (V/Q→0)", correct:false, why:"That’s shunt/low V/Q."}, {text:"Uniform V/Q = 1 throughout lung", correct:false, why:"Lung is heterogeneous."}, {text:"Areas of high DLCO with low Hb", correct:false, why:"DLCO/Hb not dead space definition."}]},
  { id:"L38-07", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"On 100% O₂, a patient’s PaO₂ barely improves. Which cause is most likely?", choices:[{text:"Large right-to-left shunt", correct:true, why:"Shunt is refractory to O₂; V/Q mismatch usually improves."}, {text:"Mild apex dead space", correct:false, why:"Dead space doesn’t lower PaO₂ much, and O₂ typically raises PaO₂."}, {text:"Low cardiac output alone", correct:false, why:"CO affects delivery, less so PaO₂ on 100% O₂."}, {text:"Anemia", correct:false, why:"Anemia lowers content, PaO₂ can still rise."}]},
  { id:"L38-08", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Which West zone relation defines zone 2 behavior?", choices:[{text:"PA > Pa > Pv (flow depends on Pa–PA)", correct:true, why:"Alveolar pressure intermittently limits flow; waterfall model."}, {text:"Pa > Pv > PA", correct:false, why:"That is zone 3."}, {text:"Pa > PA > Pv", correct:false, why:"Zone 2 is commonly summarized as Pa>PA>Pv or PA>Pa>Pv depending on reference; the key is flow ∝ (Pa−PA)."}, {text:"PA > Pv > Pa", correct:false, why:"Not a standard zone relation."}]},
  { id:"L38-09", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Why can severe emphysema produce both low DLCO and V/Q mismatch?", choices:[{text:"Destroyed alveolar walls reduce surface area and distort capillary network", correct:true, why:"↓Area → low DLCO; uneven ventilation/perfusion → V/Q mismatch."}, {text:"Thickened membrane only", correct:false, why:"Emphysema is area loss, not thickening (fibrosis)."}, {text:"Isolated anemia", correct:false, why:"Anemia lowers DLCO but not structural V/Q mismatch."}, {text:"Pure dead space without diffusion changes", correct:false, why:"Both diffusion and V/Q are affected."}]},
  { id:"L38-10", chapter:"38 Pulmonary Blood Flow/V/Q", stem:"Which ABG pattern most suggests primary hypoventilation rather than V/Q mismatch?", choices:[{text:"Elevated PaCO₂ with low PaO₂ and a normal A–a gradient", correct:true, why:"Hypoventilation lowers PAO₂/PaO₂ and raises PaCO₂ without widening A–a."}, {text:"Low PaO₂ with widened A–a gradient and low PaCO₂", correct:false, why:"That pattern suggests V/Q mismatch with compensatory hyperventilation."}, {text:"Normal PaO₂ and PaCO₂ with high A–a gradient", correct:false, why:"Inconsistent."}, {text:"Low PaCO₂ with normal A–a gradient", correct:false, why:"Not typical of hypoventilation."}]},

  /* L39 Control of Breathing (10) */
  { id:"L39-01", chapter:"39 Control of Breathing", stem:"An overdose of opioids causes profound bradypnea. Which medullary network is directly suppressed?", choices:[{text:"preBötzinger complex (rhythm generator)", correct:true, why:"Opioids depress preBötC → decreased inspiratory rhythm and hypoventilation."}, {text:"Apneustic center", correct:false, why:"Apneustic lesions cause prolonged inspiration; not the opioid target."}, {text:"Corticospinal motor cortex", correct:false, why:"Volitional breathing can be affected, but automatic rhythm is medullary."}, {text:"Dorsal column nuclei", correct:false, why:"Not respiratory rhythm."}]},
  { id:"L39-02", chapter:"39 Control of Breathing", stem:"Which stimulus most strongly activates CENTRAL chemoreceptors to increase ventilation?", choices:[{text:"↓ CSF pH from CO₂ diffusion across the BBB", correct:true, why:"CO₂ crosses BBB → H⁺ rises in CSF → central drive up."}, {text:"↓ PaO₂ to 70 mmHg", correct:false, why:"Peripheral chemoreceptors sense hypoxemia; central focus on pH/CO₂."}, {text:"↑ arterial H⁺ that cannot cross BBB", correct:false, why:"H⁺ per se crosses poorly; central signal is CO₂-derived."}, {text:"Slowly adapting stretch receptor activation", correct:false, why:"Hering–Breuer influences pattern, not central chemo drive."}]},
  { id:"L39-03", chapter:"39 Control of Breathing", stem:"Carotid body denervation causes what ventilatory change at sea level?", choices:[{text:"Blunted hypoxic ventilatory response with relatively preserved CO₂ response", correct:true, why:"Peripheral chemoreceptors sense hypoxemia strongly; central CO₂ sensing remains."}, {text:"Loss of central chemoreception", correct:false, why:"Central chemoreceptors are intact."}, {text:"Marked hyperventilation at rest", correct:false, why:"Response to hypoxia is reduced, not increased."}, {text:"Complete apnea in sleep", correct:false, why:"Not typically complete apnea; hypoxic response is dulled."}]},
  { id:"L39-04", chapter:"39 Control of Breathing", stem:"Which pattern best characterizes obstructive sleep apnea during an event?", choices:[{text:"Increasing inspiratory effort with absent airflow until arousal", correct:true, why:"Upper airway collapse → effort without flow → desaturation → arousal."}, {text:"No inspiratory effort and no airflow", correct:false, why:"That is central sleep apnea."}, {text:"Hyperventilation with rising PaCO₂", correct:false, why:"Hyperventilation lowers PaCO₂."}, {text:"Cheyne–Stokes periodicity due to prolonged circulation time", correct:false, why:"That’s central instability (e.g., heart failure)."}]},
  { id:"L39-05", chapter:"39 Control of Breathing", stem:"A patient with pontine lesion loses the pneumotaxic influence. Expected change?", choices:[{text:"Prolonged inspiratory efforts (apneustic breathing)", correct:true, why:"Loss of inspiratory off-switch → apneustic pattern."}, {text:"Complete loss of rhythm generation", correct:false, why:"Medullary generators persist."}, {text:"Isolated ataxic breathing from medullary damage", correct:false, why:"That’s a medullary lesion pattern."}, {text:"Immediate apnea with normal CO₂", correct:false, why:"Not typical from pneumotaxic loss alone."}]},
  { id:"L39-06", chapter:"39 Control of Breathing", stem:"During moderate exercise, which combination describes arterial vs venous gases in a trained athlete?", choices:[{text:"PaO₂/PaCO₂ ≈ maintained; PvO₂ falls and PvCO₂ rises", correct:true, why:"Ventilation and perfusion rise to maintain arterial gases; tissues extract more → venous changes."}, {text:"PaCO₂ rises markedly", correct:false, why:"Ventilation increases to hold PaCO₂ near normal."}, {text:"PaO₂ falls sharply", correct:false, why:"Generally maintained at submax workloads."}, {text:"DLCO falls", correct:false, why:"DLCO increases via recruitment/distension."}]},
  { id:"L39-07", chapter:"39 Control of Breathing", stem:"Which afferents mediate the Hering–Breuer inflation reflex that helps terminate inspiration?", choices:[{text:"Slowly adapting stretch receptors via vagus", correct:true, why:"Inflation activates SARs → vagal input → inspiratory cutoff."}, {text:"Rapidly adapting irritant receptors", correct:false, why:"RIRs trigger cough/bronchoconstriction."}, {text:"J-receptors in interstitium", correct:false, why:"J-receptors drive rapid shallow breathing in edema."}, {text:"Muscle spindles in diaphragm", correct:false, why:"Proprioception, not H–B reflex."}]},
  { id:"L39-08", chapter:"39 Control of Breathing", stem:"Cheyne–Stokes breathing in heart failure results primarily from:", choices:[{text:"Increased loop gain with delayed circulatory feedback to chemoreceptors", correct:true, why:"Slow circulation → overshoot/undershoot of ventilation → periodic breathing."}, {text:"Fixed upper airway collapse", correct:false, why:"That is OSA."}, {text:"Loss of central chemoreceptors", correct:false, why:"Chemoreceptors are intact but unstable feedback."}, {text:"Permanent pontine damage", correct:false, why:"Not required."}]},
  { id:"L39-09", chapter:"39 Control of Breathing", stem:"Which response emerges when PaO₂ falls below ~60 mmHg in healthy adults?", choices:[{text:"Steep increase in ventilation via peripheral chemoreceptors", correct:true, why:"Carotid bodies strongly activate below ~60 mmHg."}, {text:"Central chemoreceptors increase drive to hypoxia directly", correct:false, why:"Central respond to CO₂/pH."}, {text:"Ventilation decreases to conserve O₂", correct:false, why:"It increases."}, {text:"Apnea unless CO₂ rises", correct:false, why:"Hypoxia alone stimulates ventilation via peripherals."}]},
  { id:"L39-10", chapter:"39 Control of Breathing", stem:"A patient with chronic hypercapnia from COPD is given excessive supplemental O₂. What dangerous change may occur?", choices:[{text:"Worsening V/Q mismatch and reduced ventilatory drive → rising PaCO₂", correct:true, why:"O₂ can blunt hypoxic drive and reverse HPV, increasing V/Q mismatch; careful titration needed."}, {text:"Immediate respiratory alkalosis from hyperventilation", correct:false, why:"Drive often falls, not rises."}, {text:"Massive increase in DLCO", correct:false, why:"DLCO unrelated."}, {text:"Complete bronchodilation cures obstruction", correct:false, why:"O₂ does not bronchodilate."}]},

  /* L40 Altitude (10) */
  { id:"L40-01", chapter:"40 Altitude", stem:"On arrival to 3,500 m, what limits the initial hypoxic hyperventilation?", choices:[{text:"Respiratory alkalosis from hypocapnia blunts central drive until renal compensation", correct:true, why:"Hyperventilation → ↓PaCO₂ → ↑pH → central brake; kidneys excrete HCO₃⁻ over days."}, {text:"Immediate polycythemia", correct:false, why:"Erythrocytosis takes days–weeks (EPO)."}, {text:"Loss of carotid body sensitivity", correct:false, why:"Sensitivity increases with exposure."}, {text:"Increased dead space volume", correct:false, why:"Not the primary brake."}]},
  { id:"L40-02", chapter:"40 Altitude", stem:"By day 3 at altitude, ventilation is higher than day 1. Which adaptation enables this?", choices:[{text:"Renal HCO₃⁻ loss lowers CSF/arterial pH back toward normal, removing central inhibition", correct:true, why:"Permits sustained hypoxic ventilatory drive."}, {text:"Immediate rise in 2,3-BPG within minutes restores PaO₂", correct:false, why:"2,3-BPG rises over hours–days and affects unloading, not PaO₂."}, {text:"HPV disappears", correct:false, why:"HPV persists."}, {text:"Sudden increase in DLCO from fibrosis", correct:false, why:"DLCO may increase from recruitment, not fibrosis."}]},
  { id:"L40-03", chapter:"40 Altitude", stem:"Which mechanism best explains high-altitude pulmonary edema (HAPE) in susceptible individuals?", choices:[{text:"Global hypoxic pulmonary vasoconstriction → elevated PAP → capillary stress failure and leak", correct:true, why:"Widespread HPV raises pressures; heterogeneous vasoconstriction causes overperfusion and leak."}, {text:"Bronchospasm from cold dry air", correct:false, why:"HAPE is vascular, not bronchospastic."}, {text:"Massive increase in oncotic pressure", correct:false, why:"Opposite; edema relates to hydrostatic and barrier failure."}, {text:"Immediate polycythemia", correct:false, why:"Timing doesn’t fit."}]},
  { id:"L40-04", chapter:"40 Altitude", stem:"Best immediate field treatment when descent is delayed in HAPE?", choices:[{text:"Supplemental O₂ or portable hyperbaric bag", correct:true, why:"Raises inspired O₂, reduces HPV, improves oxygenation until descent possible."}, {text:"High-dose loop diuretics only", correct:false, why:"Not primary therapy; careful fluids, O₂, descent are key."}, {text:"Bronchodilators alone", correct:false, why:"Airways not the primary pathology."}, {text:"Phlebotomy", correct:false, why:"Not indicated for HAPE."}]},
  { id:"L40-05", chapter:"40 Altitude", stem:"Why is the A–a gradient typically normal at altitude in healthy individuals?", choices:[{text:"Low inspired PO₂ lowers both PAO₂ and PaO₂ proportionally", correct:true, why:"Hypoxemia from low PIO₂; diffusion and V/Q may be near normal initially."}, {text:"Large shunt develops immediately", correct:false, why:"Not typical without disease."}, {text:"Dead space increases markedly", correct:false, why:"Not the main driver of hypoxemia at altitude."}, {text:"CO poisoning occurs at altitude", correct:false, why:"Irrelevant here."}]},
  { id:"L40-06", chapter:"40 Altitude", stem:"Which adaptation most helps tissue O₂ delivery over several days without changing PaO₂?", choices:[{text:"Right shift from increased 2,3-BPG", correct:true, why:"Facilitates unloading at tissues even if PaO₂ remains low."}, {text:"Immediate polycythemia within hours", correct:false, why:"Takes days–weeks."}, {text:"Lower cardiac output to prolong transit time", correct:false, why:"CO generally increases with acclimatization."}, {text:"Decreased ventilation to save O₂", correct:false, why:"Ventilation increases."}]},
  { id:"L40-07", chapter:"40 Altitude", stem:"Periodic breathing during sleep at altitude is primarily due to:", choices:[{text:"Instability of ventilatory control with hypocapnic apnea thresholds", correct:true, why:"Hypocapnia during hyperventilation can drop PaCO₂ below the apnea threshold → periodicity."}, {text:"Upper-airway anatomy changes", correct:false, why:"Not OSA anatomy-driven."}, {text:"Pontine lesion", correct:false, why:"Neuro lesion not required."}, {text:"Complete loss of peripheral chemoreceptors", correct:false, why:"Peripherals drive much of the response."}]},
  { id:"L40-08", chapter:"40 Altitude", stem:"Acetazolamide helps acclimatization primarily by:", choices:[{text:"Inducing a metabolic acidosis that stimulates ventilation", correct:true, why:"Carbonic anhydrase inhibition → HCO₃⁻ loss → ↑ventilation despite low PaO₂."}, {text:"Increasing Hb within hours", correct:false, why:"Hb rise is EPO-mediated and slower."}, {text:"Acting as a bronchodilator", correct:false, why:"No bronchodilator effect."}, {text:"Blocking HPV", correct:false, why:"Does not selectively block HPV."}]},
  { id:"L40-09", chapter:"40 Altitude", stem:"Which change in exercise capacity is expected soon after ascent (before full acclimatization)?", choices:[{text:"Reduced maximal aerobic capacity due to limited arterial O₂ content", correct:true, why:"Lower PaO₂/ CaO₂ caps VO₂max until adaptations occur."}, {text:"Unchanged VO₂max", correct:false, why:"VO₂max falls at altitude initially."}, {text:"Increased anaerobic threshold immediately", correct:false, why:"Typically decreases initially."}, {text:"Complete normalization with hyperventilation alone", correct:false, why:"Hyperventilation helps but doesn’t normalize capacity."}]},
  { id:"L40-10", chapter:"40 Altitude", stem:"A climber develops ataxia and confusion at high altitude. Which intervention is most appropriate when descent is not immediately possible?", choices:[{text:"Supplemental O₂ and immediate descent; if delayed, portable hyperbaric and dexamethasone", correct:true, why:"High-altitude cerebral edema (HACE) is life-threatening; O₂ and descent are primary; dexamethasone helps edema."}, {text:"Bronchodilators only", correct:false, why:"Cerebral, not bronchospastic process."}, {text:"Diuretics as sole therapy", correct:false, why:"Not definitive; descent/O₂ crucial."}, {text:"Wait overnight without treatment", correct:false, why:"Risk of deterioration is high."}]}
];

/* ---------- Engine (mobile-safe init) ---------- */
const chapters = [...new Set(QUESTIONS.map(q=>q.chapter))].sort();
const sel = document.getElementById('chapterFilter');
const bar = document.getElementById('bar');
const countChip = document.getElementById('countChip');
const scoreChip = document.getElementById('scoreChip');
const shuffleBox = document.getElementById('shuffle');
const explainAll = document.getElementById('explainAll');
const quizDiv = document.getElementById('quiz');

chapters.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });

const state = { pool:[], idx:0, score:0, answered:0, showExplain:true };

function fisherYates(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

function makePool(){
  const chosen = Array.from(sel.selectedOptions).map(o=>o.value);
  let pool = QUESTIONS.filter(q=> chosen.length? chosen.includes(q.chapter): true);
  if (shuffleBox.checked) pool = fisherYates(pool);
  return pool;
}

function updateMeta(){
  const total = state.pool.length || 1;
  bar.style.width = `${(state.answered/total)*100}%`;
  countChip.textContent = `${state.answered}/${total}`;
  scoreChip.textContent = `Score: ${state.score}`;
}

function render(){
  const q = state.pool[state.idx];
  quizDiv.innerHTML = '';
  if (!q){
    quizDiv.innerHTML = `<div class="card">No questions selected. Choose chapters (or leave blank for mix) and tap <b>Start / Reset</b>.</div>`;
    return;
  }
  const card = document.createElement('div'); card.className='card';
  const head = document.createElement('div'); head.className='qhead';
  head.innerHTML = `<div class="qtext"><strong>Q${state.idx+1}.</strong> ${q.stem}</div>
                    <div><span class="pill">${q.chapter}</span> <span class="pill">${q.id}</span></div>`;
  card.appendChild(head);

  q.choices.forEach((c,i)=>{
    const opt = document.createElement('label'); opt.className='opt';
    opt.innerHTML = `<input type="radio" name="q${q.id}" /> <div>${c.text}</div>`;
    opt.addEventListener('click', ()=>{
      if (opt.classList.contains('correct') || opt.classList.contains('incorrect')) return;
      // lock all options
      card.querySelectorAll('input').forEach(inp=>inp.disabled=true);
      // mark all + show explanations
      q.choices.forEach((choice,idx)=>{
        const el = card.querySelectorAll('.opt')[idx];
        el.classList.add(choice.correct?'correct':'incorrect');
        if (state.showExplain){
          const ex = document.createElement('div'); ex.className='explain';
          ex.textContent = choice.why;
          el.appendChild(ex);
        }
      });
      state.answered++;
      if (c.correct) state.score++;
      updateMeta();
      // ensure next card isn't hidden under keyboard on mobile
      setTimeout(()=>{ window.scrollBy({top:80,behavior:'smooth'}); }, 50);
    }, {once:true});
    card.appendChild(opt);
  });

  const foot = document.createElement('div'); foot.className='footer';
  const info = document.createElement('div'); info.textContent = `Question ${state.idx+1} of ${state.pool.length}`;
  const btns = document.createElement('div'); btns.className='btnRow';
  const prev = document.createElement('button'); prev.textContent='⟵ Prev'; prev.className='ghost';
  const next = document.createElement('button'); next.textContent= state.idx<state.pool.length-1 ? 'Next ⟶' : 'Finish';
  prev.onclick=()=>{ if(state.idx>0){state.idx--; render(); window.scrollTo({top:0,behavior:'smooth'});} };
  next.onclick=()=>{ if(state.idx<state.pool.length-1){state.idx++; render(); window.scrollTo({top:0,behavior:'smooth'});} else { showSummary(); } };
  btns.append(prev,next);
  foot.append(info,btns);
  card.appendChild(foot);

  quizDiv.appendChild(card);
}

function showSummary(){
  const pct = Math.round((state.score/state.pool.length)*100);
  quizDiv.innerHTML = `
    <div class="card">
      <h2 style="margin:0 0 8px">Review & Score</h2>
      <div class="sub" style="margin-bottom:10px">You scored <strong>${state.score}/${state.pool.length}</strong> (${pct}%).</div>
      <div class="row" style="margin-bottom:10px;flex-wrap:wrap;gap:6px">
        ${[...new Set(state.pool.map(q=>q.chapter))].map(ch=>`<span class="chip">${ch}</span>`).join('')}
      </div>
      <div class="btnRow">
        <button class="ghost" onclick="window.scrollTo({top:0,behavior:'smooth'})">Back to Top</button>
        <button onclick="document.getElementById('start').click()">Restart</button>
      </div>
    </div>
    ${state.pool.map((q,qi)=>`
      <div class="card">
        <div class="qhead">
          <div class="qtext"><strong>Q${qi+1}.</strong> ${q.stem}</div>
          <div><span class="pill">${q.chapter}</span> <span class="pill">${q.id}</span></div>
        </div>
        ${q.choices.map(c=>`
          <div class="opt ${c.correct?'correct':'incorrect'}">
            <div style="margin-right:8px">${c.correct?'✅':'✖️'}</div>
            <div><strong>${c.text}</strong><div class="explain">${c.why}</div></div>
          </div>`).join('')}
      </div>
    `).join('')}
  `;
}

/* Controls */
document.getElementById('start').addEventListener('click', ()=>{
  state.pool = makePool();
  state.idx = 0; state.score = 0; state.answered = 0;
  state.showExplain = !!explainAll.checked;
  updateMeta(); render();
});
explainAll.addEventListener('change', ()=> state.showExplain = !!explainAll.checked);

/* Mobile-safe auto-start after DOM is ready (no synthetic click required) */
window.addEventListener('DOMContentLoaded', ()=>{
  state.pool = makePool();
  updateMeta();
  render();
});
/* Import/Export */
document.getElementById('btn-import').onclick = ()=>{
  const txt = document.getElementById('json-input').value.trim();
  if(!txt) return;
  try{
    const arr = JSON.parse(txt);
    if(Array.isArray(arr)){
      QUESTIONS.push(...arr);
      alert(`Imported ${arr.length} question(s). Use the chapter filter if needed, then Start/Reset.`);
    }else{
      alert('JSON must be an array of question objects.');
    }
  }catch(e){ alert('Invalid JSON.'); }
};
document.getElementById('btn-export').onclick = ()=>{
  const data = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(QUESTIONS,null,2));
  const a = document.createElement('a'); a.href = data; a.download = 'questions_L37-L40.json'; a.click();
};
</script>
</body>
</html>
